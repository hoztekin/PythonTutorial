# CRM Analytics (Müşteri İlişkileri Yönetimi Analitiği)
# CRM Nedir?
# CRM (Customer Relationship Management - Müşteri İlişkileri Yönetimi), müşterilerle olan tüm etkileşimleri yönetmek, analiz etmek ve geliştirmek için kullanılan bir sistemdir. CRM Analytics ise bu verilerin analiz edilmesiyle müşteri davranışlarını anlamak ve iş stratejileri geliştirmek için kullanılır.
# CRM Analytics'in Temel Amaçları
#
# Müşteri davranışlarını anlamak
# Satış ve pazarlama stratejilerini optimize etmek
# Müşteri memnuniyetini artırmak
# Gelir ve karlılığı maksimize etmek
# Müşteri kaybını azaltmak
#
# Temel CRM Metrikleri ve KPI'lar
# Müşteri Edinme (Acquisition)
#
# CAC (Customer Acquisition Cost): Müşteri edinme maliyeti
# Conversion Rate: Dönüşüm oranı
# Lead-to-Customer Rate: Potansiyel müşteriden gerçek müşteriye dönüşüm oranı
#
# Müşteri Elde Tutma (Retention)
#
# Churn Rate: Müşteri terk oranı
# Retention Rate: Müşteri elde tutma oranı
# Customer Lifetime Value (CLV): Müşteri yaşam boyu değeri
#
# Müşteri Değeri
#
# Average Order Value (AOV): Ortalama sipariş değeri
# Purchase Frequency: Satın alma sıklığı
# RFM Analizi: Recency (Yenilik), Frequency (Sıklık), Monetary (Parasal Değer)
#
# Müşteri Memnuniyeti
#
# NPS (Net Promoter Score): Müşteriyi tavsiye etme skoru
# CSAT (Customer Satisfaction Score): Müşteri memnuniyet skoru
# Customer Effort Score: Müşteri çaba skoru
#
# CRM Analytics'te Kullanılan Analiz Türleri
# 1. Kohort Analizi (Cohort Analysis)
# Ortak özelliklere sahip müşteri gruplarının zaman içindeki davranışlarını izler.
# Örnek: Ocak 2024'te kayıt olan müşterilerin 6 ay sonra ne kadarı hala aktif?
# 2. RFM Analizi
#
# Recency: Müşteri en son ne zaman alışveriş yaptı?
# Frequency: Ne sıklıkla alışveriş yapıyor?
# Monetary: Ne kadar para harcıyor?
#
# Bu analizle müşteriler segmentlere ayrılır (VIP müşteriler, risk altındaki müşteriler vb.)
# 3. Müşteri Segmentasyonu
# Müşterileri demografik, davranışsal veya değer özelliklerine göre gruplama.
# Örnekler:
#
# Yaş, cinsiyet, lokasyon
# Satın alma davranışı
# İlgi alanları ve tercihler
#
# 4. Tahminsel Analitik (Predictive Analytics)
#
# Müşteri terk riski tahmini
# Satın alma olasılığı tahmini
# CLV tahmini
# Cross-sell/Upsell fırsatları
#
# 5. Müşteri Yaşam Döngüsü Analizi
# Müşterinin marka ile olan yolculuğunu takip eder:
#
# Farkındalık → İlgi → Değerlendirme → Satın Alma → Sadakat → Savunuculuk
#
# CRM Analytics'te Kullanılan Satış Stratejileri
# Cross-Sell (Çapraz Satış)
# Müşteriye tamamlayıcı ürünler satma.
# Örnek: Telefon alan müşteriye kılıf ve kulaklık önermek.
# Upsell (Yukarı Satış)
# Müşteriye daha premium/pahalı versiyonu satma.
# Örnek: Ekonomi sınıfı yerine business class uçuş önermek.
# CRM Veri Kaynakları
#
# İşlem Verileri: Satın alma geçmişi, sipariş detayları
# Davranışsal Veriler: Web sitesi gezintisi, e-posta açılma oranları
# Demografik Veriler: Yaş, cinsiyet, lokasyon, gelir
# İletişim Verileri: Müşteri hizmetleri görüşmeleri, şikayetler
# Sosyal Medya Verileri: Etkileşimler, yorumlar, beğeniler
#
# Popüler CRM Araçları
#
# Salesforce: En popüler CRM platformu
# HubSpot: Pazarlama ve satış odaklı
# Microsoft Dynamics 365: Kurumsal çözümler
# Zoho CRM: KOBİ'ler için uygun
# Pipedrive: Satış odaklı basit CRM
#
# CRM Analytics'in Faydaları
# ✅ Daha iyi müşteri deneyimi - Kişiselleştirilmiş hizmet
# ✅ Satış artışı - Doğru müşteriye doğru zamanda doğru ürün
# ✅ Maliyet tasarrufu - Pazarlama ve satış kaynaklarını optimize etme
# ✅ Müşteri sadakati - Müşterileri daha uzun süre elde tutma
# ✅ Veri odaklı kararlar - Tahmine dayalı stratejiler
# Örnek Kullanım Senaryoları
# Senaryo 1: E-ticaret şirketi
#
# Son 30 günde alışveriş yapmayan müşterilere özel indirim kampanyası
# Yüksek CLV'li müşterilere VIP program önerisi
#
# Senaryo 2: Telekomünikasyon şirketi
#
# Churn risk analizi ile ayrılma ihtimali yüksek müşterilere özel teklifler
# Veri kullanım paternlerine göre paket önerileri
#
# Senaryo 3: SaaS şirketi
#
# Ürünü aktif kullanmayan müşterilere eğitim ve onboarding desteği
# Kullanım verilerine göre upsell fırsatlarını belirleme
#
#
# # CRM Analytics, modern işletmelerin müşteri odaklı stratejiler geliştirmesi için kritik bir araçtır. Veriye dayalı kararlar alarak hem müşteri memnuniyetini artırabilir hem de şirket gelirlerini optimize edebilirsiniz.


###############################################################
# RFM ile Müşteri Segmentasyonu (Customer Segmentation with RFM)
###############################################################

# 1. İş Problemi (Business Problem)
# 2. Veriyi Anlama (Data Understanding)
# 3. Veri Hazırlama (Data Preparation)
# 4. RFM Metriklerinin Hesaplanması (Calculating RFM Metrics)
# 5. RFM Skorlarının Hesaplanması (Calculating RFM Scores)
# 6. RFM Segmentlerinin Oluşturulması ve Analiz Edilmesi (Creating & Analysing RFM Segments)
# 7. Tüm Sürecin Fonksiyonlaştırılması

###############################################################
# 1. İş Problemi (Business Problem)
###############################################################

# Bir e-ticaret şirketi müşterilerini segmentlere ayırıp bu segmentlere göre
# pazarlama stratejileri belirlemek istiyor.

# Veri Seti Hikayesi
# https://archive.ics.uci.edu/ml/datasets/Online+Retail+II

# Online Retail II isimli veri seti İngiltere merkezli online bir satış mağazasının
# 01/12/2009 - 09/12/2011 tarihleri arasındaki satışlarını içeriyor.

# Değişkenler
#
# InvoiceNo: Fatura numarası. Her işleme yani faturaya ait eşsiz numara. C ile başlıyorsa iptal edilen işlem.
# StockCode: Ürün kodu. Her bir ürün için eşsiz numara.
# Description: Ürün ismi
# Quantity: Ürün adedi. Faturalardaki ürünlerden kaçar tane satıldığını ifade etmektedir.
# InvoiceDate: Fatura tarihi ve zamanı.
# UnitPrice: Ürün fiyatı (Sterlin cinsinden)
# CustomerID: Eşsiz müşteri numarası
# Country: Ülke ismi. Müşterinin yaşadığı ülke.


###############################################################
# 2. Veriyi Anlama (Data Understanding)
###############################################################

import datetime as dt
import pandas as pd
pd.set_option('display.max_columns', None)
# pd.set_option('display.max_rows', None)
pd.set_option('display.float_format', lambda x: '%.3f' % x)

df_ = pd.read_excel("datasets/online_retail_II.xlsx", sheet_name="Year 2009-2010")
df = df_.copy()
df.head()
df.shape
df.isnull().sum()

# essiz urun sayisi nedir?
df["Description"].nunique()

df["Description"].value_counts().head()

df.groupby("Description").agg({"Quantity": "sum"}).head()

df.groupby("Description").agg({"Quantity": "sum"}).sort_values("Quantity", ascending=False).head()

df["Invoice"].nunique()

df["TotalPrice"] = df["Quantity"] * df["Price"]

df.groupby("Invoice").agg({"TotalPrice": "sum"}).head()

###############################################################
# 3. Veri Hazırlama (Data Preparation)
###############################################################

df.shape
df.isnull().sum()
df.describe().T
df = df[(df['Quantity'] > 0)]
df.dropna(inplace=True)
df = df[~df["Invoice"].str.contains("C", na=False)]

###############################################################
# 4. RFM Metriklerinin Hesaplanması (Calculating RFM Metrics)
###############################################################

# Recency => Müşterinin yeniliği sıcaklığını ifade eder. Son tarihli müşteri (DÜŞÜK DEĞER İYİ PUAN)
# Frequency => Müşterinin yaptığı toplam satın alma (YÜKSEK DEĞER İYİ PUAN)
# Monetary => Müşterinin yaptığı toplam satın almalar karşılığında bıraktığı parasal değer (YÜKSEK İYİ PUAN)
df.head()

df["InvoiceDate"].max()

today_date = dt.datetime(2010, 12, 11)
type(today_date)

rfm = df.groupby('Customer ID').agg({'InvoiceDate': lambda InvoiceDate: (today_date - InvoiceDate.max()).days,
                                     'Invoice': lambda Invoice: Invoice.nunique(),
                                     'TotalPrice': lambda TotalPrice: TotalPrice.sum()})
rfm.head()

rfm.columns = ['recency', 'frequency', 'monetary']

rfm.describe().T

rfm = rfm[rfm["monetary"] > 0]
rfm.shape


###############################################################
# 5. RFM Skorlarının Hesaplanması (Calculating RFM Scores)
###############################################################

rfm["recency_score"] = pd.qcut(rfm['recency'], 5, labels=[5, 4, 3, 2, 1])

# 0-100, 0-20, 20-40, 40-60, 60-80, 80-100

rfm["frequency_score"] = pd.qcut(rfm['frequency'].rank(method="first"), 5, labels=[1, 2, 3, 4, 5])

rfm["monetary_score"] = pd.qcut(rfm['monetary'], 5, labels=[1, 2, 3, 4, 5])

rfm["RFM_SCORE"] = (rfm['recency_score'].astype(str) +
                    rfm['frequency_score'].astype(str))

rfm.describe().T

rfm[rfm["RFM_SCORE"] == "55"]

rfm[rfm["RFM_SCORE"] == "11"]

###############################################################
# 6. RFM Segmentlerinin Oluşturulması ve Analiz Edilmesi (Creating & Analysing RFM Segments)
###############################################################
# regex

# RFM isimlendirmesi
seg_map = {
    r'[1-2][1-2]': 'hibernating',
    r'[1-2][3-4]': 'at_Risk',
    r'[1-2]5': 'cant_loose',
    r'3[1-2]': 'about_to_sleep',
    r'33': 'need_attention',
    r'[3-4][4-5]': 'loyal_customers',
    r'41': 'promising',
    r'51': 'new_customers',
    r'[4-5][2-3]': 'potential_loyalists',
    r'5[4-5]': 'champions'
}

rfm['segment'] = rfm['RFM_SCORE'].replace(seg_map, regex=True)

rfm[["segment", "recency", "frequency", "monetary"]].groupby("segment").agg(["mean", "count"])

rfm[rfm["segment"] == "cant_loose"].head()
rfm[rfm["segment"] == "cant_loose"].index

new_df = pd.DataFrame()
new_df["new_customer_id"] = rfm[rfm["segment"] == "new_customers"].index

new_df["new_customer_id"] = new_df["new_customer_id"].astype(int)

new_df.to_csv("new_customers.csv")

rfm.to_csv("rfm.csv")

###############################################################
# 7. Tüm Sürecin Fonksiyonlaştırılması
###############################################################

def create_rfm(dataframe, csv=False):

    # VERIYI HAZIRLAMA
    dataframe["TotalPrice"] = dataframe["Quantity"] * dataframe["Price"]
    dataframe.dropna(inplace=True)
    dataframe = dataframe[~dataframe["Invoice"].str.contains("C", na=False)]

    # RFM METRIKLERININ HESAPLANMASI
    today_date = dt.datetime(2011, 12, 11)
    rfm = dataframe.groupby('Customer ID').agg({'InvoiceDate': lambda date: (today_date - date.max()).days,
                                                'Invoice': lambda num: num.nunique(),
                                                "TotalPrice": lambda price: price.sum()})
    rfm.columns = ['recency', 'frequency', "monetary"]
    rfm = rfm[(rfm['monetary'] > 0)]

    # RFM SKORLARININ HESAPLANMASI
    rfm["recency_score"] = pd.qcut(rfm['recency'], 5, labels=[5, 4, 3, 2, 1])
    rfm["frequency_score"] = pd.qcut(rfm["frequency"].rank(method="first"), 5, labels=[1, 2, 3, 4, 5])
    rfm["monetary_score"] = pd.qcut(rfm['monetary'], 5, labels=[1, 2, 3, 4, 5])

    # cltv_df skorları kategorik değere dönüştürülüp df'e eklendi
    rfm["RFM_SCORE"] = (rfm['recency_score'].astype(str) +
                        rfm['frequency_score'].astype(str))


    # SEGMENTLERIN ISIMLENDIRILMESI
    seg_map = {
        r'[1-2][1-2]': 'hibernating',
        r'[1-2][3-4]': 'at_risk',
        r'[1-2]5': 'cant_loose',
        r'3[1-2]': 'about_to_sleep',
        r'33': 'need_attention',
        r'[3-4][4-5]': 'loyal_customers',
        r'41': 'promising',
        r'51': 'new_customers',
        r'[4-5][2-3]': 'potential_loyalists',
        r'5[4-5]': 'champions'
    }

    rfm['segment'] = rfm['RFM_SCORE'].replace(seg_map, regex=True)
    rfm = rfm[["recency", "frequency", "monetary", "segment"]]
    rfm.index = rfm.index.astype(int)

    if csv:
        rfm.to_csv("rfm.csv")

    return rfm

df = df_.copy()

rfm_new = create_rfm(df, csv=True)










